<?php
if (Auth::isGuest()) {
    $guest = AuthGuest::getGuest();

    if ($guest->hasOption(GuestOptions::EMAIL_UPLOAD_PAGE_ACCESS)) {
        if (!$guest->last_activity || $guest->last_activity < strtotime('-1 hour')) {
            // Send mail to guest the owner of the voucher
            ApplicationMail::quickSend('guest_access_upload_page', $guest->owner, $guest);

            $guest->last_activity = time();
            $guest->save();
        }
    }
}
?>


<form id="upload_form" class="row" enctype="multipart/form-data" accept-charset="utf-8" method="post">
    <!--    <h2 id="upload">{tr:upload_page}</h2>-->
    <section class="box">
        <div class="files"></div>

        <div class="file_selector">
            <label for="files" class="mandatory">{tr:select_file} :</label>

            <input name="files" type="file" multiple />

            <?php echo LegacyUploadProgress::getTrackingInput() ?>
        </div>

        <div class="files_dragdrop">
            <div class="instructions radius" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:drag_and_drop_hint}">{tr:drag_and_drop}</div>
        </div>

        <div class="files_actions">
            <div>
                <a class="clear_all radius" href="#"  data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:clear_all_hint}">
                    {tr:clear_all}
                </a>
            </div>

            <div>
                <a  class="select_files radius" href="#" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:select_files_hint}">
                    {tr:select_files}
                </a>
            </div>

            <div class="stats">
                <div class="number_of_files">{tr:number_of_files} : <span class="value"></span></div>
                <div class="size">{tr:size} : <span class="value"></span></div>
                <div class="uploaded">{tr:uploaded} : <span class="value"></span></div>
                <div class="average_speed">{tr:average_speed} : <span class="value"></span></div>
            </div>
        </div>
    </section>
    <section class="upload_form_data box">
        <article class="small-12 medium-6 columns table-cell" >
            <!--            <div class="fieldcontainer">-->
            <?php $emails = Auth::isGuest() ? array(AuthGuest::getGuest()->email) : Auth::user()->email_addresses ?>

            <label for="from" class="mandatory">{tr:from} :</label>

            <?php if (count($emails) > 1) { ?>

                <select name="from" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:from_hint}">
                    <?php foreach ($emails as $email) { ?>
                        <option><?php echo $email ?></option>
                    <?php } ?>
                </select>

            <?php } else echo $emails[0] ?></label>
            <!--            </div>-->

            <!--            <div class="fieldcontainer" data-related-to="message">-->
            <label for="to" class="mandatory fieldcontainer" data-related-to="message">{tr:to} :</label>

            <?php if (Auth::isGuest() && AuthGuest::getGuest()->hasOption(GuestOptions::CAN_ONLY_SEND_TO_ME)) { ?>
                <?php echo AuthGuest::getGuest()->user_email ?>
            <?php } else { ?>
                <div class="recipients"></div>

                <input name="to" id="to" type="text" title="{tr:email_separator_msg}" value="" placeholder="{tr:enter_to_email}"  class="fieldcontainer radius" data-related-to="message" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" />
            <?php } ?>
            <!--            </div>-->

            <!--            <div class="fieldcontainer" data-related-to="message">-->
            <label for="subject" class="fieldcontainer" data-related-to="message">{tr:subject} ({tr:optional}) :
                <input name="subject" type="text" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" class="radius" title="{tr:subject_hint}"/>
            </label>
            <!--            </div>-->

            <!--            <div class="fieldcontainer" data-related-to="message">-->
            <label for="message" class="fieldcontainer" data-related-to="message">{tr:message} ({tr:optional}) : 
                <textarea name="message" rows="4" data-related-to="message" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" class="radius" title="{tr:message_hint}" ></textarea>
            </label>
            <!--            </div>-->

            <?php if (!Auth::isGuest() && array_key_exists('get_a_link', Transfer::availableOptions())) { ?>
                <div class="fieldcontainer" data-related-to="get_a_link">
                    <input name="get_a_link" type="checkbox" data-related-to="message" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" class="radius tip-top" title="{tr:get_a_link_hint}"/><label for="get_a_link" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" class="radius tip-top" title="{tr:get_a_link_hint}"> {tr:get_a_link}</label>
                </div>
            <?php } ?>

            <div>
                <?php if (Auth::isGuest()) { ?>
                    <input type="hidden" name="guest_token" value="<?php echo AuthGuest::getGuest()->token ?>" />
                <?php } ?>

            </div>
        </article>


        <article class="small-12 medium-6 columns table-cell">
            <?php
            $displayoption = function($name, $cfg) {
                if ($name == 'get_a_link')
                    return;

                $checked = $cfg['default'] ? 'checked="checked"' : '';

                echo '<div class="fieldcontainer" data-option="' . $name . '">';
                echo '  <label for="' . $name . '"><input name="' . $name . '" type="checkbox" ' . $checked . ' />' . Lang::tr($name);
                echo '  </label>';

                if ($name == TransferOptions::ENABLE_RECIPIENT_EMAIL_DOWNLOAD_COMPLETE)
                    echo '<div class="info message">' . Lang::tr('enable_recipient_email_download_complete_warning') . '</div>';

                echo '</div>';
            };
            ?>

            <div class="basic_options">

                <label for="datepicker" id="datepicker_label" class="mandatory radius">{tr:expiry_date} :</label>
                <input name="expires" type="text" autocomplete="off" title="{tr:dp_date_format}" value="<?php echo Utilities::formatDate(Transfer::getDefaultExpire()) ?>" />
                

                <?php
                if (Config::get('transfer_recipients_lang_selector_enabled')) {
                    $opts = array();
                    $code = Lang::getBaseCode();
                    foreach (Lang::getAvailableLanguages() as $id => $dfn) {
                        $selected = ($id == $code) ? 'selected="selected"' : '';
                        $opts[] = '<option value="' . $id . '" ' . $selected . '>' . Utilities::sanitizeOutput($dfn['name']) . '</option>';
                    }
                    
                    ?>
                    <label for="lang" class="fieldcontainer" data-related-to="message">{tr:recipients_notifications_language} :
                        <select name="lang" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" class="radius" title="{tr:rcpt_lang_hint}" >
                            <?php echo implode('', $opts) ?>
                        </select>
                    </label>
                    <?php
                }
                ?>

                <?php
                if (!Auth::isGuest())
                    foreach (Transfer::availableOptions(false) as $name => $cfg)
                        $displayoption($name, $cfg)
                ?>
            </div>

            <?php if ((!Auth::isGuest() && count(Transfer::availableOptions(true))) || (Config::get('terasender_enabled') && Config::get('terasender_advanced'))) { ?>
                <a class="toggle_advanced_options radius" href="#" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:advanced_settings_hint}">{tr:advanced_settings}</a>

                <div class="advanced_options">
                    <?php
                    if (!Auth::isGuest())
                        foreach (Transfer::availableOptions(true) as $name => $cfg)
                            $displayoption($name, $cfg)
                    ?>

                    <?php if (Config::get('terasender_enabled') && Config::get('terasender_advanced')) { ?>
                        <div class="fieldcontainer">
                            <label for="workerCount">{tr:terasender_worker_count}</label>

                            <input id="terasender_worker_count" type="text" value="<?php echo Config::get('terasender_worker_count') ?>"/>
                            <br />
                        </div>
                    <?php } ?>
                </div>
            <?php } /* End of advanced settings div. */ ?>
        </article>
    </section>

    <?php if (Config::get('AuP')) { ?>
        <div class="aup fieldcontainer box">
            <label for="aup" title="{tr:showhide}">
                {tr:accepttoc} [<span>{tr:showhide}</span>]


                <?php
                $aupChecked = '';
                if (Config::get('aup_default') || (isset($_SESSION['aup']) /* && !$authvoucher->aVoucher() */))
                    $aupChecked = 'checked="checked"';
                ?>
                <input name="aup" type="checkbox" <?php echo $aupChecked; ?> value="true"/>
            </label>
            <div class="terms">{tr:aupterms}</div>
        </div>
    <?php } ?>

    <section class="buttons">
        <a href="#" class="start radius tip-top" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:start_hint}">
            <span class="fa fa-cloud-upload fa-lg"></span> {tr:send}
        </a>
        <a href="#" class="restart not_displayed radius tip-top" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:restart_hint}">
            <span class="fa fa-cloud-upload fa-lg"></span> {tr:restart}
        </a>
        <a href="#" class="pause not_displayed radius tip-top" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:pause_hint}">
            <span class="fa fa-pause fa-lg"></span> {tr:pause}
        </a>
        <a href="#" class="resume not_displayed radius tip-top" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:resume_hint}">
            <span class="fa fa-play fa-lg"></span> {tr:resume}
        </a>
        <a href="#" class="stop not_displayed radius tip-top" data-tooltip data-options="disable_for_touch:true" aria-haspopup="true" title="{tr:stop_hint}">
            <span class="fa fa-stop fa-lg"></span> {tr:stop}
        </a>
    </section>
</form>

<script type="text/javascript" src="{path:js/upload_page.js}"></script>

