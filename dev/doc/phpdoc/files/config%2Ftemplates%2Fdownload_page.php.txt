<main class="box row">
    <h1>{tr:download_page}</h1>

    <?php
    if (!array_key_exists('token', $_REQUEST))
        throw new DownloadMissingTokenException();

    $token = $_REQUEST['token'];
    if (!Utilities::isValidUID($token))
        throw new DownloadBadTokenFormatException($token);

    $recipient = Recipient::fromToken($token); // Throws
    $transfer = $recipient->transfer;

    if ($transfer->isExpired())
        throw new TransferExpiredException();

    if ($transfer->status != TransferStatuses::AVAILABLE)
        throw new TransferNotAvailableException();
    ?>

    <div class="disclamer">
        {tr:download_disclamer}
    </div>

    <div class="download_info" >
        <ul class="table-header-group">
            <li class="from table-cell">{tr:from}</li>

            <li class="created table-cell">{tr:created}</li>

            <li class="expires table-cell">{tr:expires}</li>

            <li class="size table-cell">{tr:size}</li>

            <?php if ($transfer->subject) { ?>
                <li class="subject table-cell">{tr:subject}</li>
            <?php } ?>
        </ul>

        <ul class="table-row">
            <li class="from table-cell"> <?php echo Utilities::sanitizeOutput($transfer->user_email) ?></li>

            <li class="created table-cell"><?php echo Utilities::sanitizeOutput(Utilities::formatDate($transfer->created)) ?></li>

            <li class="expires table-cell"><?php echo Utilities::sanitizeOutput(Utilities::formatDate($transfer->expires)) ?></li>

            <li class="expires table-cell"><?php echo Utilities::sanitizeOutput(Utilities::formatBytes($transfer->size)) ?></li>

            <?php if ($transfer->subject) { ?>
                <li class="subject table-cell"><?php echo Utilities::sanitizeOutput($transfer->subject) ?></li>
            <?php } ?>
        </ul>
    </div>
    <?php if ($transfer->message) { ?>
        <div class="message_info">
            <span class="table-header-group table-cell">{tr:message}</span>
            <p class="table-cell">
                <?php echo Utilities::sanitizeOutput($transfer->message) ?>
            </p>
        </div>
    <?php } ?>

    <div class="files box" data-count="<?php echo count($transfer->files) ?>">
        <div class="select_all">
            <span class="fa fa-lg fa-mail-reply fa-rotate-270"></span>
            <span class="select clickable">
                <span class="fa fa-2x fa-square-o" title="{tr:select_all_for_archive_download}"></span>
                <span>{tr:select_all_for_archive_download}</span>
            </span>
        </div>
        <?php foreach ($transfer->files as $file) { ?>
            <div class="file" data-id="<?php echo $file->id ?>" >
                <ul class="table-row">
                    <li class="table-cell">
                        <span class="select clickable fa fa-lg fa-square-o " title="{tr:select_for_archive_download}"></span>
                        <span class="name "><?php echo Utilities::sanitizeOutput($file->name) ?></span><br /><span class="size"><?php echo Utilities::formatBytes($file->size) ?></span>
                    </li>
                    <li class="table-cell">
                        <a href="#" class="download" title="{tr:download_file}">
                            <span class="fa fa-lg fa-download"></span>
                            {tr:download}
                        </a>
                    </li>
                </ul>
            </div>
        <?php } ?>
        <div class="archive">
            <ul class="table-row">
                <li class="table-cell">
                    <p class="archive_message">{tr:archive_message} <p/> <!--</div>-->

                    <!--<div class="mac_archive_message">-->
                    <p class="mac_archive_message">{tr:mac_archive_message} : <a href="<?php echo Config::get('mac_unzip_link'); ?>" target="_blank"><?php echo Config::get('mac_unzip_name'); ?></a>.</p>
                </li>
                <li class="table-cell">
                    <a href="#" class="archive_download " title="{tr:archive_download}">
                        <span class="fa fa-2x fa-download"></span>
                        {tr:archive_download}
                    </a>
                </li>
        </div>

        <div class='transfer' data-id="<?php echo $transfer->id ?>"></div>  
    </div>
</main>

<script type="text/javascript" src="{path:js/download_page.js}"></script>

